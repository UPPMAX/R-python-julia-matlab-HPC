

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Isolated environments with renv &mdash; Introduction to running R, Python, Julia and MATLAB in HPC 2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_lesson.css?v=e9df6548" />
      <link rel="stylesheet" type="text/css" href="../_static/term_role_formatting.css?v=4194e21c" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_rtd_theme_ext_color_contrast.css?v=8e8ea19f" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=a5c4661c" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=60dbed4a"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=6dbb43f8"></script>
      <script src="../_static/minipres.js?v=a0d29692"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../_static/tabs.js?v=3030b3cb"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Running R in batch mode" href="batchR.html" />
    <link rel="prev" title="Packages" href="packagesR.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Introduction to running R, Python, Julia and MATLAB in HPC
              <img src="../_static/hpc2n-lunarc-uppmax-hpc-course.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Pre-requirements:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../prereqs.html">Pre-requirements</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">COMMON:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../common/login.html">Log in session</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/ondemand-desktop.html">Desktop On Demand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/use_tarball.html">Use the tarball with exercises</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python Lessons:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python/intro.html">Introduction Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/load_runPython.html">Load and run python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/packages.html">Python packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/isolated.html">Isolated environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/batchPython.html">Running Python in batch mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/GPU.html">Using GPUs with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/interactivePython.html">Interactive work on the compute nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/jupyter.html">Jupyter on compute nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/parallel.html">Parallel and multithreaded functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/condaUPPMAX.html">Conda at UPPMAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/summaryPython.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/evaluationPython.html">Evaluation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Julia Lessons:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../julia/introJulia.html">Introduction Julia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/load_runJulia.html">Load and run Julia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/isolatedJulia.html">Packages and isolated environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/batchJulia.html">Running Julia in batch mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/parallel.html">Parallel and multithreaded functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/interactiveJulia.html">Sessions: Interactive work on compute nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/summaryJulia.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/evaluationJulia.html">Evaluation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">R Lessons:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introR.html">Introduction R</a></li>
<li class="toctree-l1"><a class="reference internal" href="load_runR.html">Load and run R</a></li>
<li class="toctree-l1"><a class="reference internal" href="packagesR.html">Packages</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Isolated environments with <code class="docutils literal notranslate"><span class="pre">renv</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="#general-procedures">General procedures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#workflow">Workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-creating-a-renv-and-installing-knitr">Example - Creating a renv and installing <code class="docutils literal notranslate"><span class="pre">knitr</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#conda-uppmax">Conda (UPPMAX)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="batchR.html">Running R in batch mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/parallel.html">Parallel and multithreaded functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="interactiveR.html">Interactive work on the compute nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="rstudio.html">Using RStudio</a></li>
<li class="toctree-l1"><a class="reference internal" href="MLR.html">ML with R</a></li>
<li class="toctree-l1"><a class="reference internal" href="summaryR.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluationR.html">Evaluation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Matlab Lessons:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../matlab/introMatlab.html">Introduction to MATLAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../matlab/load_runMatlab.html">Load and Run MATLAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../matlab/slurmMatlab.html">Slurm job scheduler and MATLAB in terminal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../matlab/jobsMatlab.html">MATLAB GUI and SLURM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/parallel.html">Parallel and multithreaded functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../matlab/add_onsMatlab.html">Add-Ons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../matlab/local_desktopMatlab.html">Session-UPPMAX: Matlab client on the desktop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../matlab/jupyterMatlab.html">Session: Matlab in Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../matlab/summaryMatlab.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../matlab/evaluationMatlab.html">Evaluation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extra reading:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../extra/isolated_extra.html">Isolated environments, extra exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="morepackages.html">More about R packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="packagesBianca.html">Packages at Bianca (parallel session)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extra/matlab.html">Extra reading about MATLAB in HPC</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Introduction to running R, Python, Julia and MATLAB in HPC</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Isolated environments with <code class="docutils literal notranslate"><span class="pre">renv</span></code></li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/UPPMAX/R-python-julia-MATLAB-HPC/blob/main/docs/r/isolatedR.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="isolated-environments-with-renv">
<h1>Isolated environments with <code class="docutils literal notranslate"><span class="pre">renv</span></code><a class="headerlink" href="#isolated-environments-with-renv" title="Link to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Isolated environments solve a couple of problems:</p>
<ul class="simple">
<li><p>You can install specific, also older, versions into them.</p></li>
<li><p>You can create one for each project and no problem if the two projects
require different versions.</p></li>
<li><p>You can remove the environment and create a new one, if not needed or with
errors.</p></li>
</ul>
</div>
<p>R is not very well known for virtual environments like Python and Julia. However:</p>
<p>The <code class="docutils literal notranslate"><span class="pre">renv</span></code> package is a new effort to bring project-local R dependency management to your projects.
The goal is for <code class="docutils literal notranslate"><span class="pre">renv</span></code> to be a robust, stable replacement for the Packrat package, with fewer surprises and better default behaviors.</p>
<div class="admonition-questions questions admonition" id="questions-0">
<p class="admonition-title">Questions</p>
<ul class="simple">
<li><p>How to work with isolated R environments at HPC2N, UPPMAX and LUNARC?</p></li>
</ul>
</div>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Give a general introduction to isolated environments in R.</p></li>
<li><p>Show an example with installing an R package to an isolated renv environment.</p></li>
</ul>
</div>
<div class="admonition-goal admonition">
<p class="admonition-title">Goal</p>
<ul class="simple">
<li><p>You will learn how to create a renv and install a package to it.</p></li>
</ul>
</div>
<section id="general-procedures">
<h2>General procedures<a class="headerlink" href="#general-procedures" title="Link to this heading"></a></h2>
<p>You will now and then have the situation that your project(s) use different versions of R and different versions of packages. This is great if you need different versions of a package for different tasks, for instance. This is easily solved with isolated environments.</p>
<p>Isolated environments lets you create separate workspaces for different versions of R and/or different versions of packages. You can activate and deactivate them one at a time, and work as if the other workspace does not exist.</p>
<p>Underlying the philosophy of <code class="docutils literal notranslate"><span class="pre">renv</span></code> is that any of your existing workflows should just work as they did before.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">renv</span></code> helps manage library paths (and other project-specific state) to help isolate your project’s R dependencies</p></li>
<li><p>the existing tools you’ve used for managing R packages (e.g. <code class="docutils literal notranslate"><span class="pre">install.packages()</span></code>, <code class="docutils literal notranslate"><span class="pre">remove.packages()</span></code>) should work as they did before.</p></li>
<li><p>[Introduction to renv](<a class="reference external" href="https://rstudio.github.io/renv/articles/renv.html">https://rstudio.github.io/renv/articles/renv.html</a>)</p></li>
</ul>
</section>
<section id="workflow">
<h2>Workflow<a class="headerlink" href="#workflow" title="Link to this heading"></a></h2>
<p>The general workflow when working with <code class="docutils literal notranslate"><span class="pre">renv</span></code> is:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Call <code class="docutils literal notranslate"><span class="pre">renv::init()</span></code> from inside <code class="docutils literal notranslate"><span class="pre">R</span></code> to initialize a new project-local environment with a private R library,</p></li>
<li><p>Work in the project as normal, installing and removing new R packages as they are needed in the project,</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">renv::snapshot()</span></code> to save the state of the project library to the lockfile (called <code class="docutils literal notranslate"><span class="pre">renv.lock</span></code>),</p></li>
<li><p>Continue working on your project, installing and updating R packages as needed.</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">renv::snapshot()</span></code> again to save the state of your project library if your attempts to update R packages were successful, or call <code class="docutils literal notranslate"><span class="pre">renv::restore()</span></code> to revert to the previous state as encoded in the lockfile if your attempts to update packages introduced some new problems.</p></li>
</ol>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">renv::init()</span></code> function attempts to ensure the newly-created project library includes all R packages currently used by the project. It does this by crawling R files within the project for dependencies with the <code class="docutils literal notranslate"><span class="pre">renv::dependencies()</span></code> function. The discovered packages are then installed into the project library with the <code class="docutils literal notranslate"><span class="pre">renv::hydrate()</span></code> function, which will also attempt to save time by copying packages from your user library (rather than reinstalling from CRAN) as appropriate.</p>
<p>Calling <code class="docutils literal notranslate"><span class="pre">renv::init()</span></code> will also write out the infrastructure necessary to automatically load and use the private library for new R sessions launched from the project root directory. This is accomplished by creating (or amending) a project-local <code class="docutils literal notranslate"><span class="pre">.Rprofile</span></code> with the necessary code to load the project when the R session is started.</p>
<p>If you’d like to initialize a project without attempting dependency discovery and installation – that is, you’d prefer to manually install the packages your project requires on your own – you can use <code class="docutils literal notranslate"><span class="pre">renv::init(bare</span> <span class="pre">=</span> <span class="pre">TRUE)</span></code> to initialize a project with an empty project library.</p>
<section id="example-creating-a-renv-and-installing-knitr">
<h3>Example - Creating a renv and installing <code class="docutils literal notranslate"><span class="pre">knitr</span></code><a class="headerlink" href="#example-creating-a-renv-and-installing-knitr" title="Link to this heading"></a></h3>
<div class="admonition-type-along type-along important admonition" id="type-along-0">
<p class="admonition-title">Type-Along</p>
<ul class="simple">
<li><p>First create a project under the course project directory (Kebnekaise and Rackham) or in your home directory (Cosmos) and cd to it</p></li>
</ul>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">UPPMAX</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">HPC2N</button><button aria-controls="panel-0-0-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-2" name="0-2" role="tab" tabindex="-1">LUNARC</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>-v<span class="w"> </span>/proj/r-py-jl-m-rackham/&lt;your-dir&gt;/r_proj<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$_</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>-v<span class="w"> </span>/proj/nobackup/r-py-jl-m/&lt;your-dir&gt;/r_proj<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$_</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-2" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-2" name="0-2" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>-v<span class="w"> </span><span class="nv">$HOME</span>/r_proj<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$_</span>
</pre></div>
</div>
</div></div>
<ul class="simple">
<li><p>Make sure you have loaded <code class="docutils literal notranslate"><span class="pre">R</span></code> and <code class="docutils literal notranslate"><span class="pre">R_packages</span></code> on UPPMAX or <code class="docutils literal notranslate"><span class="pre">R</span></code> and <code class="docutils literal notranslate"><span class="pre">R-bundle-Bioconductor</span> <span class="pre">(and</span> <span class="pre">possibly</span> <span class="pre">R-bundle-CRAN</span> <span class="pre">if</span> <span class="pre">you</span> <span class="pre">use</span> <span class="pre">one</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">newest</span> <span class="pre">versions</span> <span class="pre">of</span> <span class="pre">R)</span></code> on HPC2N and <code class="docutils literal notranslate"><span class="pre">R</span></code> on LUNARC.</p></li>
</ul>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">UPPMAX</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">HPC2N</button><button aria-controls="panel-1-1-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-2" name="1-2" role="tab" tabindex="-1">LUNARC</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ml<span class="w"> </span>R/4.1.1<span class="w"> </span>R_packages/4.1.1
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ml<span class="w"> </span>GCC/11.3.0<span class="w">  </span>OpenMPI/4.1.4<span class="w">  </span>R/4.2.1<span class="w"> </span>R-bundle-Bioconductor/3.15-R-4.2.1
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-2" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-2" name="1-2" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ml<span class="w"> </span>GCC/11.3.0<span class="w">  </span>OpenMPI/4.1.4<span class="w"> </span>R/4.2.1
</pre></div>
</div>
</div></div>
<ul>
<li><p>Next, launch the <code class="docutils literal notranslate"><span class="pre">R</span></code> interpreter and initialize a <code class="docutils literal notranslate"><span class="pre">renv</span></code> environment.</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="n">renv</span><span class="o">::</span><span class="nf">init</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Exit the session</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="nf">quit</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Verify that the <code class="docutils literal notranslate"><span class="pre">renv</span></code> directory as well as lock file was created</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-l
<span class="go">drwxrwsr-x 4 matpiq p_py-r-jl 4096 Feb  9 16:32 renv</span>
<span class="go">-rw-rw-r-- 1 matpiq p_py-r-jl  354 Feb  9 16:32 renv.lock</span>
</pre></div>
</div>
</li>
<li><p>Relaunch R and check the library paths</p>
<div class="highlight-Rconsole notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt; </span><span class="nf">.libPaths</span><span class="p">()</span>
<span class="go">[1] &quot;/crex/proj/py-r-jl/matpiq/r_proj/renv/library/R-4.1/x86_64-pc-linux-gnu&quot;</span>
<span class="go">[2] &quot;/scratch/RtmpMgprgX/renv-system-library&quot;</span>
</pre></div>
</div>
</li>
</ul>
<p><strong>Question</strong>: What happens if you leave the project directory?</p>
<p>As a last step we can try installing some package into the environment. Let’s re-enter the project directory (if you left it) and try installing  <code class="docutils literal notranslate"><span class="pre">knitr</span></code>. Start R again if you had exited it.</p>
<div class="highlight-rconsole notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt; </span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;knitr&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You could exit R and check what was installed</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>renv/library/R-4.1/x86_64-pc-linux-gnu
<span class="go">lrwxrwxrwx  1 matpiq p_py-r-jl  121 Feb  9 16:44 evaluate -&gt; /domus/h1/matpiq/.cache/R/renv/cache/v5/R-4.1/x86_64-pc-linux-gnu/evaluate/0.20/4b68aa51edd89a0e044a66e75ae3cc6c/evaluate</span>
<span class="go">lrwxrwxrwx  1 matpiq p_py-r-jl  115 Feb  9 16:44 highr -&gt; /domus/h1/matpiq/.cache/R/renv/cache/v5/R-4.1/x86_64-pc-linux-gnu/highr/0.10/06230136b2d2b9ba5805e1963fa6e890/highr</span>
<span class="go">lrwxrwxrwx  1 matpiq p_py-r-jl  115 Feb  9 16:44 knitr -&gt; /domus/h1/matpiq/.cache/R/renv/cache/v5/R-4.1/x86_64-pc-linux-gnu/knitr/1.42/8329a9bcc82943c8069104d4be3ee22d/knitr</span>
<span class="go">dr-xr-sr-x 10 matpiq sw        4096 Sep  6  2021 renv</span>
<span class="go">lrwxrwxrwx  1 matpiq p_py-r-jl  113 Feb  9 16:44 xfun -&gt; /domus/h1/matpiq/.cache/R/renv/cache/v5/R-4.1/x86_64-pc-linux-gnu/xfun/0.37/a6860e1400a8fd1ddb6d9b4230cc34ab/xfun</span>
<span class="go">lrwxrwxrwx  1 matpiq p_py-r-jl  114 Feb  9 16:44 yaml -&gt; /domus/h1/matpiq/.cache/R/renv/cache/v5/R-4.1/x86_64-pc-linux-gnu/yaml/2.3.7/0d0056cc5383fbc240ccd0cb584bf436/yaml</span>
</pre></div>
</div>
</div>
<p><em>Note</em>: Notice that the packages exposed in the <code class="docutils literal notranslate"><span class="pre">renv</span></code> library are actually just symbolic links to the home directory. This allows the same package to be shared across environments. However, having this cached in the home directory might be suboptimal because of limited storage. We can change this behavior by setting <code class="docutils literal notranslate"><span class="pre">use.cache::</span> <span class="pre">FALSE</span></code> in the <code class="docutils literal notranslate"><span class="pre">renv/settings.dcf</span></code> file. Another option is to set the <code class="docutils literal notranslate"><span class="pre">RENV_PATHS_CACHE</span></code> to someplace else, for example <code class="docutils literal notranslate"><span class="pre">R_LIBS_SITE</span></code> if the R_packages module is loaded. See more here: <a class="reference external" href="https://rstudio.github.io/renv/articles/renv.html#cache">https://rstudio.github.io/renv/articles/renv.html#cache</a>.</p>
<p><em>Note</em>: You can also do all of this directly through Rstudio when initializing a project.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To access the packages installed in the renv, you either need to activate it or be in that directory. Load the R module and prerequisites (and possibly R_packages on UPPMAX and R-bundle-Bioconductor / R-bundle-CRAN on HPC2N) and do:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">renv::load(&quot;&lt;path-to-your-renv&gt;&quot;)</span></code> inside your R script to access the packages installed in it. Or run from inside your renv directory.</p></li>
</ul>
</div>
<div class="admonition-installing-datarium exercise important admonition" id="exercise-0">
<p class="admonition-title">Installing “datarium”</p>
<p>We will need this for an exercise in the “ML with R” section (only on Cosmos and Kebnekaise - Rackham has the library included already).</p>
<ul>
<li><p>First create a new project under the course project directory (Kebnekaise and Rackham) or in your home directory (Cosmos) and cd to it.</p></li>
<li><p>Then make sure you have loaded the modules:</p>
<blockquote>
<div><ul class="simple">
<li><p>Kebnekaise/Cosmos: R/4.2.1 and prerequsites + R-bundle-Bioconductor/3.15-R-4.2.1</p></li>
<li><p>Rackham: R/4.1.1 R_packages/4.1.1</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Launch the R interpreter and initialize a renv environment.</p></li>
<li><p>Install the package “datarium”</p></li>
</ul>
</div>
<div class="dropdown solution important admonition" id="solution-0">
<p class="admonition-title">Solution</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Create a project directory and change to it:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir -v &lt;path-to-your-dir&gt;/r_proj_dat &amp;&amp; cd $_
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Load R, prerequisites, and other needed modules</p></li>
</ol>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">Rackham</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">Kebnekaise</button><button aria-controls="panel-2-2-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-2" name="2-2" role="tab" tabindex="-1">Cosmos</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ml</span> <span class="n">R</span><span class="o">/</span><span class="mf">4.1.1</span> <span class="n">R_packages</span><span class="o">/</span><span class="mf">4.1.1</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ml</span> <span class="n">GCC</span><span class="o">/</span><span class="mf">11.3.0</span>  <span class="n">OpenMPI</span><span class="o">/</span><span class="mf">4.1.4</span>  <span class="n">R</span><span class="o">/</span><span class="mf">4.2.1</span> <span class="n">R</span><span class="o">-</span><span class="n">bundle</span><span class="o">-</span><span class="n">Bioconductor</span><span class="o">/</span><span class="mf">3.15</span><span class="o">-</span><span class="n">R</span><span class="o">-</span><span class="mf">4.2.1</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-2" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-2" name="2-2" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ml</span> <span class="n">GCC</span><span class="o">/</span><span class="mf">11.3.0</span>  <span class="n">OpenMPI</span><span class="o">/</span><span class="mf">4.1.4</span> <span class="n">R</span><span class="o">/</span><span class="mf">4.2.1</span> <span class="n">R</span><span class="o">-</span><span class="n">bundle</span><span class="o">-</span><span class="n">Bioconductor</span><span class="o">/</span><span class="mf">3.15</span><span class="o">-</span><span class="n">R</span><span class="o">-</span><span class="mf">4.2.1</span>
</pre></div>
</div>
</div></div>
<ol class="arabic simple" start="3">
<li><p>Launch the R interpreter and initialize a renv environment.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ R
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">renv</span><span class="p">::</span><span class="n">init</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Install “datarium”</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">install</span><span class="o">.</span><span class="n">packages</span><span class="p">(</span><span class="s2">&quot;datarium&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Save it</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">renv</span><span class="p">::</span><span class="n">snapshot</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>Try loading it with</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">library</span><span class="p">(</span><span class="n">datarium</span><span class="p">)</span>
</pre></div>
</div>
<p>NOTE: Later, when you need it, for instance in a batch script, you can either</p>
<ul class="simple">
<li><p>work from inside the r_proj directory</p></li>
<li><p>Load the renv with: <code class="docutils literal notranslate"><span class="pre">renv::load(&quot;&lt;path-to-your-renv&gt;&quot;)</span></code></p></li>
</ul>
</div></blockquote>
</div>
</section>
</section>
<section id="conda-uppmax">
<h2>Conda (UPPMAX)<a class="headerlink" href="#conda-uppmax" title="Link to this heading"></a></h2>
<p>Another possibility on UPPMAX is instead using Conda to create a virtual environment. For example, create an environment <code class="docutils literal notranslate"><span class="pre">yaml</span></code> file. Let’s call it <code class="docutils literal notranslate"><span class="pre">r_env.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my_r_env</span>
<span class="nt">channels</span><span class="p">:</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">r</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">r-essentials</span>
</pre></div>
</div>
<p>Then load conda and create the environment</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>module<span class="w"> </span>load<span class="w"> </span>conda
<span class="gp">$ </span>conda<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>r_env.yaml
</pre></div>
</div>
<p>Next, we can activate the environment and verify that we have indeed have an
isolated R environment</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">source</span><span class="w"> </span>activate<span class="w"> </span>r_env
<span class="gp">$ </span>which<span class="w"> </span>R
<span class="go">~/.conda/envs/my_r_env/bin/R</span>
</pre></div>
</div>
<p>If we want to store our environments somewhere else, e.g. in the project directory (recommended), we can define the environmental variable
<code class="docutils literal notranslate"><span class="pre">CONDA_ENVS_PATH=&quot;path/to/your/env&quot;</span></code>.</p>
<p>Benefits of using Conda:</p>
<ul class="simple">
<li><p>Easy to install a specific R version (Not bound to module system)</p></li>
<li><p>Good integration with Jupyter</p></li>
<li><p>Should be familiar to people with a Python background</p></li>
</ul>
<div class="admonition-keypoints keypoints admonition" id="keypoints-0">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>With a virtual environment you can tailor an environment with specific versions for R and packages, not interfering with other installed versions.</p></li>
<li><p>Make it for each project you have for reproducibility.</p></li>
<li><p>UPPMAX and LUNARC have Conda as an alternative to <code class="docutils literal notranslate"><span class="pre">renv</span></code></p></li>
</ul>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="packagesR.html" class="btn btn-neutral float-left" title="Packages" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="batchR.html" class="btn btn-neutral float-right" title="Running R in batch mode" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, UPPMAX &amp; HPC2N.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>