

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Slurm job scheduler and MATLAB in terminal &mdash; Introduction to running R, Python, Julia and MATLAB in HPC 2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_lesson.css?v=e9df6548" />
      <link rel="stylesheet" type="text/css" href="../_static/term_role_formatting.css?v=4194e21c" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_rtd_theme_ext_color_contrast.css?v=8e8ea19f" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=a5c4661c" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=60dbed4a"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=6dbb43f8"></script>
      <script src="../_static/minipres.js?v=a0d29692"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../_static/tabs.js?v=3030b3cb"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="MATLAB GUI and SLURM" href="jobsMatlab.html" />
    <link rel="prev" title="Load and Run MATLAB" href="load_runMatlab.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Introduction to running R, Python, Julia and MATLAB in HPC
              <img src="../_static/hpc2n-lunarc-uppmax-hpc-course.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Pre-requirements:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../prereqs.html">Pre-requirements</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">COMMON:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../common/login.html">Log in session</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/ondemand-desktop.html">Desktop On Demand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/use_tarball.html">Use the tarball with exercises</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python Lessons:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python/intro.html">Introduction Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/load_runPython.html">Load and run python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/packages.html">Python packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/isolated.html">Isolated environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/batchPython.html">Running Python in batch mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/GPU.html">Using GPUs with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/interactivePython.html">Interactive work on the compute nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/jupyter.html">Jupyter on compute nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/parallel.html">Parallel and multithreaded functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/condaUPPMAX.html">Conda at UPPMAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/summaryPython.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/evaluationPython.html">Evaluation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Julia Lessons:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../julia/introJulia.html">Introduction Julia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/load_runJulia.html">Load and run Julia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/isolatedJulia.html">Packages and isolated environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/batchJulia.html">Running Julia in batch mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/parallel.html">Parallel and multithreaded functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/interactiveJulia.html">Sessions: Interactive work on compute nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/summaryJulia.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/evaluationJulia.html">Evaluation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">R Lessons:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../r/introR.html">Introduction R</a></li>
<li class="toctree-l1"><a class="reference internal" href="../r/load_runR.html">Load and run R</a></li>
<li class="toctree-l1"><a class="reference internal" href="../r/packagesR.html">Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../r/isolatedR.html">Isolated environments with <code class="docutils literal notranslate"><span class="pre">renv</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../r/batchR.html">Running R in batch mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/parallel.html">Parallel and multithreaded functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../r/interactiveR.html">Interactive work on the compute nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../r/rstudio.html">Using RStudio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../r/MLR.html">ML with R</a></li>
<li class="toctree-l1"><a class="reference internal" href="../r/summaryR.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../r/evaluationR.html">Evaluation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Matlab Lessons:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introMatlab.html">Introduction to MATLAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="load_runMatlab.html">Load and Run MATLAB</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Slurm job scheduler and MATLAB in terminal</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#useful-commands-to-the-batch-system">Useful commands to the batch system</a></li>
<li class="toctree-l2"><a class="reference internal" href="#first-time-configuration">First time configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#matlab-terminal-interface">MATLAB terminal interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#starting-matlab">Starting MATLAB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#job-settings-at-the-command-line">Job settings at the command line</a></li>
<li class="toctree-l3"><a class="reference internal" href="#job-settings-in-the-cluster-profile-manager">Job settings in the Cluster Profile Manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-a-job-from-within-matlab-terminal-interface">Running a job from within MATLAB terminal interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#serial">Serial</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parallel">Parallel</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#matlab-batch-jobs">MATLAB batch jobs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#serial-batch-jobs">Serial batch jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parallel-batch-script">Parallel batch script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#gpu-code">GPU code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#inside-matlab">Inside MATLAB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#batch-scripts">Batch scripts</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="jobsMatlab.html">MATLAB GUI and SLURM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common/parallel.html">Parallel and multithreaded functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="add_onsMatlab.html">Add-Ons</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_desktopMatlab.html">Session-UPPMAX: Matlab client on the desktop</a></li>
<li class="toctree-l1"><a class="reference internal" href="jupyterMatlab.html">Session: Matlab in Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="summaryMatlab.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluationMatlab.html">Evaluation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extra reading:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../extra/isolated_extra.html">Isolated environments, extra exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../r/morepackages.html">More about R packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../r/packagesBianca.html">Packages at Bianca (parallel session)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extra/matlab.html">Extra reading about MATLAB in HPC</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Introduction to running R, Python, Julia and MATLAB in HPC</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Slurm job scheduler and MATLAB in terminal</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/UPPMAX/R-python-julia-MATLAB-HPC/blob/main/docs/matlab/slurmMatlab.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="slurm-job-scheduler-and-matlab-in-terminal">
<h1>Slurm job scheduler and MATLAB in terminal<a class="headerlink" href="#slurm-job-scheduler-and-matlab-in-terminal" title="Link to this heading"></a></h1>
<div class="admonition-questions questions admonition" id="questions-0">
<p class="admonition-title">Questions</p>
<ul class="simple">
<li><p>What is a batch job?</p></li>
<li><p>How to make a batch job for MATLAB?</p></li>
<li><p>How to configure the cluster for MATLAB?</p></li>
</ul>
</div>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Understand and use the Slurm scheduler</p></li>
<li><p>Configure the cluster</p></li>
<li><p>Start (MATLAB) batch jobs from the command line</p></li>
<li><p>Try example</p></li>
</ul>
</div>
<div class="admonition-compute-allocations-in-this-workshop admonition">
<p class="admonition-title">Compute allocations in this workshop</p>
<ul class="simple">
<li><p>Rackham: <code class="docutils literal notranslate"><span class="pre">naiss2024-22-1202</span></code></p></li>
<li><p>Kebnekaise: <code class="docutils literal notranslate"><span class="pre">hpc2n2024-114</span></code></p></li>
<li><p>Cosmos: <code class="docutils literal notranslate"><span class="pre">lu2024-7-80</span></code></p></li>
</ul>
</div>
<div class="admonition-storage-space-for-this-workshop admonition">
<p class="admonition-title">Storage space for this workshop</p>
<ul class="simple">
<li><p>Rackham: <code class="docutils literal notranslate"><span class="pre">/proj/r-py-jl-m-rackham</span></code></p></li>
<li><p>Kebnekaise: <code class="docutils literal notranslate"><span class="pre">/proj/nobackup/r-py-jl-m</span></code></p></li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Any longer, resource-intensive, or parallel jobs must be run through a <strong>batch script</strong>.</p>
</div>
<p>The batch system used at UPPMAX, HPC2N, and LUNARC is called SLURM. The same is the case at most of the Swedish HPC centres.</p>
<p>SLURM is an Open Source job scheduler, which provides three key functions:</p>
<ul class="simple">
<li><p>Keeps track of available system resources</p></li>
<li><p>Enforces local system resource usage and job scheduling policies</p></li>
<li><p>Manages a job queue, distributing work across resources according to policies</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><dl class="simple">
<dt>If you have attended the other days you have learned that you ask for compute resources via the sbatch command.</dt><dd><ul>
<li><p>In order to run a batch job, you need to create and submit a SLURM submit file (also called a batch submit file, a batch script, or a job script).</p></li>
<li><p>Guides and documentation at: <a class="reference external" href="https://docs.hpc2n.umu.se/documentation/batchsystem/intro/">https://docs.hpc2n.umu.se/documentation/batchsystem/intro/</a> and <a class="reference external" href="https://docs.uppmax.uu.se/cluster_guides/slurm/">https://docs.uppmax.uu.se/cluster_guides/slurm/</a> and <a class="reference external" href="https://lunarc-documentation.readthedocs.io/en/latest/manual/submitting_jobs/manual_basic_job/">https://lunarc-documentation.readthedocs.io/en/latest/manual/submitting_jobs/manual_basic_job/</a></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>MATLAB is well integrated with SLURM and because of that there are several ways to run these jobs:</dt><dd><ul>
<li><p>Using the job scheduler (<code class="docutils literal notranslate"><span class="pre">batch</span></code> command) in MATLAB Desktop/graphical interface (This is the Recommended Use).</p></li>
<li><p>Starting a <code class="docutils literal notranslate"><span class="pre">parpool</span></code> with a predefined cluster (This allows for more interactivity).</p></li>
<li><p>Writing a batch script as for any other software and submitting the job with the <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> command from SLURM
(This could be useful if you want to run long jobs and you don’t need to modify the code in the meantime).</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>In the following sections we will extend these concepts.</p></li>
</ul>
</div>
<section id="useful-commands-to-the-batch-system">
<h2>Useful commands to the batch system<a class="headerlink" href="#useful-commands-to-the-batch-system" title="Link to this heading"></a></h2>
<p>Before going into MATLAB specifics for batch jobs, we should look briefly at some useful commands.</p>
<ul class="simple">
<li><p>Submit job: <code class="docutils literal notranslate"><span class="pre">sbatch</span> <span class="pre">&lt;jobscript.sh&gt;</span></code></p></li>
<li><p>Get list of your jobs: <code class="docutils literal notranslate"><span class="pre">squeue</span> <span class="pre">--me</span></code></p></li>
<li><p>Check on a specific job: <code class="docutils literal notranslate"><span class="pre">scontrol</span> <span class="pre">show</span> <span class="pre">job</span> <span class="pre">&lt;job-id&gt;</span></code></p></li>
<li><p>Delete a specific job: <code class="docutils literal notranslate"><span class="pre">scancel</span> <span class="pre">&lt;job-id&gt;</span></code></p></li>
<li><p>Useful info about a job: <code class="docutils literal notranslate"><span class="pre">sacct</span> <span class="pre">-l</span> <span class="pre">-j</span> <span class="pre">&lt;job-id&gt;</span> <span class="pre">|</span> <span class="pre">less</span> <span class="pre">-S</span></code></p></li>
<li><p>Url to a page with info about the job (Kebnekaise only): <code class="docutils literal notranslate"><span class="pre">job-usage</span> <span class="pre">&lt;job-id&gt;</span></code></p></li>
</ul>
</section>
<section id="first-time-configuration">
<h2>First time configuration<a class="headerlink" href="#first-time-configuration" title="Link to this heading"></a></h2>
<p>In order to be able to submit jobs to the SLURM queue, you need to configure MATLAB:</p>
<div class="admonition-follow-these-instructions-to-configure-matlab admonition">
<p class="admonition-title">Follow these instructions to configure MATLAB</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.hpc2n.umu.se/resources/software/configure-matlab-2018">HPC2N</a></p></li>
<li><p><a class="reference external" href="https://docs.uppmax.uu.se/software/matlab/#first-time-since-may-13-2024">UPPMAX</a></p></li>
<li><p><a class="reference external" href="https://lunarc-documentation.readthedocs.io/en/latest/guides/applications/MATLAB/#configuration-at-the-command-line">LUNARC</a></p></li>
</ul>
</div>
<ul class="simple">
<li><p>To be able to use MATLAB 2019b, and later, together with the batch system, MATLAB needs to be configured to use a cluster profile.</p></li>
<li><p>This needs to be done only once for each cluster and each version of MATLAB.</p></li>
<li><p>Note that this is done AFTER loading MATLAB.</p></li>
</ul>
<p>This will provide a set of default specifications for batch and parallel jobs called a <strong>cluster profile</strong>. These specifications can be changed or added to at runtime, and it is possible to have more than one profile for a single release.</p>
<div class="admonition-configcluster-sh-from-the-terminal admonition">
<p class="admonition-title">configCluster(.sh) from the terminal</p>
<p>You do all these ONCE for each cluster, and for each version of MATLAB you use. You do this AFTER loading MATLAB but before starting the MATLAB command line or GUI.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">UPPMAX</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">HPC2N</button><button aria-controls="panel-0-0-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-2" name="0-2" role="tab" tabindex="-1">LUNARC</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">configCluster</span><span class="o">.</span><span class="n">sh</span> <span class="o">&lt;</span><span class="n">project</span><span class="o">-</span><span class="nb">id</span><span class="o">&gt;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">configCluster</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-2" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-2" name="0-2" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">configCluster</span><span class="o">.</span><span class="n">sh</span> <span class="o">&lt;</span><span class="n">project</span><span class="o">-</span><span class="nb">id</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Choose “cosmos” when prompted.</p>
</div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At LUNARC it is also possible do the cluster profile configuration on the MATLAB command line. In that case you just do</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">configCluster</span>
</pre></div>
</div>
<p>Be sure to choose “cosmos” when prompted. After this, you can use the Cluster Profile Manager to add to or refine submission parameters.</p>
</div>
<p><strong>Example (HPC2N):</strong></p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/configcluster.png"><img alt="../_images/configcluster.png" src="../_images/configcluster.png" style="width: 350px;" />
</a>
</figure>
<p>Apart from whether or not to include the .sh and the project-id, it should work the same at all centers.</p>
<p><strong>Example (LUNARC):</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[bbrydsoe@cosmos3 ~]$ configCluster.sh lu2024-7-68
salloc: Granted job allocation 927531
salloc: Waiting for resource configuration
salloc: Nodes cn011 are ready for job

                            &lt; M A T L A B (R) &gt;
                  Copyright 1984-2023 The MathWorks, Inc.
             R2023b Update 7 (23.2.0.2515942) 64-bit (glnxa64)
                              January 30, 2024


To get started, type doc.
For product information, visit www.mathworks.com.


ip =

    &quot;10.21.0.11&quot;

        [1] aurora
        [2] cosmos
2
Select a cluster [1-2]: &gt;&gt;Complete.  Default cluster profile set to &quot;cosmos R2023b&quot;.

        Must set AccountName and WallTime before submitting jobs to COSMOS.  E.g.

        &gt;&gt; c = parcluster;
        &gt;&gt; c.AdditionalProperties.AccountName = &#39;account-name&#39;;
        &gt;&gt; % 5 hour walltime
        &gt;&gt; c.AdditionalProperties.WallTime = &#39;05:00:00&#39;;
        &gt;&gt; c.saveProfile

MATLAB is configured for multi-node parallelism.

salloc: Relinquishing job allocation 927531
salloc: Job allocation 927531 has been revoked.
[bbrydsoe@cosmos3 ~]$
</pre></div>
</div>
<div class="admonition-exercise exercise important admonition" id="exercise-0">
<p class="admonition-title">Exercise</p>
<p>Login to either HPC2N, UPPMAX, or LUNARC if you have not already.</p>
<p>Load the newest version of MATLAB (find with <code class="docutils literal notranslate"><span class="pre">ml</span> <span class="pre">spider</span> <span class="pre">MATLAB</span></code>).</p>
<p>On the command line, run <code class="docutils literal notranslate"><span class="pre">configCluster.sh</span></code> on HPC2N or <code class="docutils literal notranslate"><span class="pre">configCluster.sh</span> <span class="pre">&lt;project-id&gt;</span></code> on UPPMAX/LUNARC.</p>
</div>
</section>
<section id="matlab-terminal-interface">
<h2>MATLAB terminal interface<a class="headerlink" href="#matlab-terminal-interface" title="Link to this heading"></a></h2>
<div class="admonition-content admonition">
<p class="admonition-title">Content</p>
<ul class="simple">
<li><p>starting Matlab on the command line</p></li>
<li><dl class="simple">
<dt>Job settings</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">c.parcluster</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c.AdditionalProperties.</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c.batch</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Starting a job from within Matlab</p></li>
</ul>
</div>
<p>This section will show you how to use MATLAB completely from the shell/terminal without having to open the GUI. This could be useful if you only have a regular SSH connection or otherwise need to run something fast and lightweight instead of having to open the GUI. This is an extra advantage when you have a poor network connection.</p>
<section id="starting-matlab">
<h3>Starting MATLAB<a class="headerlink" href="#starting-matlab" title="Link to this heading"></a></h3>
<p>To start Matlab on the command line, without running the GUI, load the MATLAB version and do</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matlab</span> <span class="o">-</span><span class="n">singleCompThread</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">nosplash</span> <span class="o">-</span><span class="n">nodesktop</span>
</pre></div>
</div>
<p>This starts MATLAB.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ul class="simple">
<li><p>On the login-nodes MATLAB MUST be started with the option ‘-singleCompThread’, preventing MATLAB from using more than one thread.</p></li>
</ul>
</div>
<p><strong>Working in MATLAB</strong></p>
<p>Of course, we can work in MATLAB like this in exactly the same way as in the GUI:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ matlab -singleCompThread -nodisplay -nosplash -nodesktop
Opening log file:  /home/b/bbrydsoe/java.log.43927

                                  &lt; M A T L A B (R) &gt;
                        Copyright 1984-2023 The MathWorks, Inc.
                   R2023a Update 4 (9.14.0.2306882) 64-bit (glnxa64)
                                     June 19, 2023


To get started, type doc.
For product information, visit www.mathworks.com.

&gt;&gt; a = [ 1 2 3 ; 4 5 6; 7 8 9];
&gt;&gt; b = [ 7 5 6 ; 2 0 8; 5 7 1];
&gt;&gt; c = a + b

c =

     8     7     9
     6     5    14
    12    15    10

&gt;&gt; d = a - b

d =

    -6    -3    -3
     2     5    -2
     2     1     8

&gt;&gt; e = c + d;
&gt;&gt; e

e =

     2     4     6
     8    10    12
    14    16    18

&gt;&gt;
</pre></div>
</div>
<p>However, we are now going to look at running in batch on the compute nodes.</p>
</section>
<section id="job-settings-at-the-command-line">
<h3>Job settings at the command line<a class="headerlink" href="#job-settings-at-the-command-line" title="Link to this heading"></a></h3>
<p>If you want to run a MATLAB program on the cluster with batch, you have to set some things for the job. Start MATLAB and do this.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">c</span><span class="o">=</span><span class="n">parcluster</span><span class="p">(</span><span class="s1">&#39;CLUSTER&#39;</span><span class="p">);</span>
<span class="o">&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">AdditionalProperties</span><span class="o">.</span><span class="n">AccountName</span> <span class="o">=</span> <span class="s1">&#39;PROJECT-ID&#39;</span><span class="p">;</span>
<span class="o">&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">AdditionalProperties</span><span class="o">.</span><span class="n">WallTime</span> <span class="o">=</span> <span class="s1">&#39;HHH1:MM:SS&#39;</span><span class="p">;</span>
<span class="o">&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">saveProfile</span>
</pre></div>
</div>
<p>In order to list the content of your profile, do <code class="docutils literal notranslate"><span class="pre">c.AdditionalProperties</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On UPPMAX, you should do</p>
<p><code class="docutils literal notranslate"><span class="pre">c=parcluster;</span></code></p>
<p>instead of</p>
<p><code class="docutils literal notranslate"><span class="pre">c=parcluster('CLUSTER')</span></code>.</p>
<p>You also need to add <code class="docutils literal notranslate"><span class="pre">c.AdditionalProperties.ProcsPerNode=20;</span></code> for UPPMAX.</p>
</div>
<p><strong>Example, for HPC2N</strong></p>
<p>Asking for 1 hour walltime.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">c</span><span class="o">=</span><span class="n">parcluster</span><span class="p">(</span><span class="s1">&#39;kebnekaise&#39;</span><span class="p">);</span>
<span class="o">&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">AdditionalProperties</span><span class="o">.</span><span class="n">AccountName</span> <span class="o">=</span> <span class="s1">&#39;hpc2n2024-114&#39;</span><span class="p">;</span>
<span class="o">&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">AdditionalProperties</span><span class="o">.</span><span class="n">WallTime</span> <span class="o">=</span> <span class="s1">&#39;01:00:00&#39;</span><span class="p">;</span>
<span class="o">&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">saveProfile</span>
</pre></div>
</div>
<div class="admonition-run-job-settings exercise important admonition" id="exercise-1">
<p class="admonition-title">Run job settings</p>
<p>Do the job settings on one of:</p>
<ul class="simple">
<li><p>HPC2N: CLUSTER=kebnekaise</p></li>
<li><p>UPPMAX: no CLUSTER, as said above - i.e. just c=parcluster;</p></li>
<li><p>LUNARC: CLUSTER=cosmos R2023b</p></li>
</ul>
<p>Remember, the project-id is:</p>
<ul class="simple">
<li><p>Rackham: naiss2024-22-1202</p></li>
<li><p>Kebnekaise: hpc2n2024-114</p></li>
<li><p>Cosmos: lu2024-7-80</p></li>
</ul>
<p>Since we are just doing a short test, you can use 15 min instead of 1 hour as I did.</p>
<p>Also remember the <code class="docutils literal notranslate"><span class="pre">c.AdditionalProperties.ProcsPerNode=20</span></code> if you are on UPPMAX.</p>
<p>Test that it was added (with <code class="docutils literal notranslate"><span class="pre">c.AdditionalProperties</span></code>).</p>
</div>
</section>
<section id="job-settings-in-the-cluster-profile-manager">
<h3>Job settings in the Cluster Profile Manager<a class="headerlink" href="#job-settings-in-the-cluster-profile-manager" title="Link to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is about the GUI.</p>
<p>You can change the job settings (or make them all together) inside the GUI. To do that, you change the job settings within the Cluster Profile Manager.</p>
<p>Note that this is ONLY in the case you want to use the GUI. You can work completely from within the MATLAB terminal interface if you want.</p>
</div>
<p>If you run MATLAB in the GUI after having configured the cluster, MATLAB will start with a default cluster profile, typically something that includes the name of the cluster. This is just the set of configurations that were set by <cite>configCluster</cite>. You can view, edit, and/or add to this profile by clicking the <code class="docutils literal notranslate"><span class="pre">Parallel</span></code> menu icon and selecting <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">and</span> <span class="pre">Manage</span> <span class="pre">Clusters</span></code>.</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="../_images/Rackham-matlab-parallel.png"><img alt="../_images/Rackham-matlab-parallel.png" src="../_images/Rackham-matlab-parallel.png" style="width: 550px;" />
</a>
<figcaption>
<p><span class="caption-text">Location of Parallel Menu in GUI.</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="../_images/Rackham-matlab-cluster-profile-mgr.png"><img alt="../_images/Rackham-matlab-cluster-profile-mgr.png" src="../_images/Rackham-matlab-cluster-profile-mgr.png" style="width: 550px;" />
</a>
<figcaption>
<p><span class="caption-text">Cluster Profile Manager.</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>If you scroll down in the window that appears when you select the right cluster, you will see a box titled <code class="docutils literal notranslate"><span class="pre">Scheduler</span> <span class="pre">Plugin</span></code>. This box lets you set SBATCH parameters like</p>
<ul class="simple">
<li><p>Your account name (project name),</p></li>
<li><p>Your email address,</p></li>
<li><p>The memory per CPU, including units,</p></li>
<li><p>The number of processes per node,</p></li>
<li><p>Which partition you want,</p></li>
<li><p>Whether you need an exclusive node,</p></li>
<li><p>The name of your reservation, and most importantly,</p></li>
<li><p>The wall time for your job.</p></li>
</ul>
<figure class="align-center" id="id3">
<a class="reference internal image-reference" href="../_images/Rackham-matlab-cluster-profile-mgr2.png"><img alt="../_images/Rackham-matlab-cluster-profile-mgr2.png" src="../_images/Rackham-matlab-cluster-profile-mgr2.png" style="width: 550px;" />
</a>
<figcaption>
<p><span class="caption-text">Editing parameters of Scheduler Plugin in Cluster Profile Manager.</span><a class="headerlink" href="#id3" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>In other words, almost anything you might otherwise set by calling <code class="docutils literal notranslate"><span class="pre">c.AdditionalProperties.&lt;insert_property&gt;=...</span></code> can be set in the GUI in this scheduler plugin. Just keep in mind that these settings are saved between sessions.</p>
<p>If you are on Desktop On Demand on LUNARC, these settings do not override the parameters set in the GfxLauncher for the MATLAB GUI session itself, but rather to any batch jobs you submit from <em>within</em> the GUI.</p>
<p>More about MATLAB in the GUI in the next session.</p>
</section>
<section id="running-a-job-from-within-matlab-terminal-interface">
<h3>Running a job from within MATLAB terminal interface<a class="headerlink" href="#running-a-job-from-within-matlab-terminal-interface" title="Link to this heading"></a></h3>
<p>Starting a simple MATLAB program inside MATLAB on the terminal. It will as default use your cluster profile which you just created and saved above.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">job</span> <span class="o">=</span> <span class="n">batch</span><span class="p">(</span><span class="s1">&#39;myScript&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>batch does not block MATLAB and you can continue working while computations take place.</p>
<p>If you want to block MATLAB until the job finishes, use the wait function on the job object.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wait</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
</pre></div>
</div>
<p>By default, MATLAB saves the Command Window output from the batch job to the diary of the job. To retrieve it, use the diary function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">diary</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</pre></div>
</div>
<p>After the job finishes, fetch the results by using the load function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">load</span><span class="p">(</span><span class="n">job</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>or with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">fetchOutputs</span><span class="p">{:}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>If you need the Job id, run <code class="docutils literal notranslate"><span class="pre">squeue</span> <span class="pre">--me</span></code> on the command line.</p></li>
<li><p>To get the MATLAB jobid do <code class="docutils literal notranslate"><span class="pre">id=job.ID</span></code> within MATLAB.</p></li>
<li><p>To see if the job is running, inside MATLAB, do <code class="docutils literal notranslate"><span class="pre">job.State</span></code></p></li>
</ul>
<section id="serial">
<h4>Serial<a class="headerlink" href="#serial" title="Link to this heading"></a></h4>
<p>After starting MATLAB, you can use this</p>
<ul class="simple">
<li><p>Get a handle to the cluster (remember, on Rackham, just use <code class="docutils literal notranslate"><span class="pre">c=parcluster;</span></code></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">c</span><span class="o">=</span><span class="n">parcluster</span><span class="p">(</span><span class="s1">&#39;CLUSTER&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>myfcn is a command or serial MATLAB program.</p></li>
<li><p>N is the number of output arguments from the evaluated function</p></li>
<li><p>x1, x2, x3,… are the input arguments</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">job</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="nd">@myfcn</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="p">{</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">x3</span><span class="p">,</span><span class="o">...</span><span class="p">})</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Query the state of the job</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">j</span><span class="o">.</span><span class="n">State</span>
</pre></div>
</div>
<ul class="simple">
<li><p>If the state of the job is finished, fetch the result</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">j</span><span class="o">.</span><span class="n">fetchOutputs</span><span class="p">{:}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>when you do not need the result anymore, delete the job</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">j</span><span class="o">.</span><span class="n">delete</span>
</pre></div>
</div>
<p>If you are running a lot of jobs or if you want to quit MATLAB and restart it at a later time you can retrieve the list of jobs:</p>
<ul class="simple">
<li><p>Get the list of jobs</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jobs</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Jobs</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Retrieve the output of the second job</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">j2</span><span class="o">=</span><span class="n">jobs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">j2</span><span class="o">.</span><span class="n">fetchOutputs</span><span class="p">{:}</span>
</pre></div>
</div>
<div class="admonition-type-along type-along important admonition" id="type-along-0">
<p class="admonition-title">Type-Along</p>
<p>After doing the job settings further up, let us try running an example. We will use the example <code class="docutils literal notranslate"><span class="pre">add2.m</span></code> which adds two numbers. I just used 1 and 2, but you can pick any numbers you want. You can find the <code class="docutils literal notranslate"><span class="pre">add2.m</span></code> script in the exercises/matlab directory or you can ‘download it &lt;<a class="reference external" href="https://raw.githubusercontent.com/UPPMAX/R-python-julia-matlab-HPC/refs/heads/main/exercises/matlab/add2.m">https://raw.githubusercontent.com/UPPMAX/R-python-julia-matlab-HPC/refs/heads/main/exercises/matlab/add2.m</a>&gt;’_ from here.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">job</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="nd">@add2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">})</span>
</pre></div>
</div>
<p>Check if it has finished with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">State</span>
</pre></div>
</div>
<p>When it has finished, retrieve the result with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">fetchOutputs</span><span class="p">{:}</span>
</pre></div>
</div>
</div>
</section>
<section id="parallel">
<h4>Parallel<a class="headerlink" href="#parallel" title="Link to this heading"></a></h4>
<p>Running parallel batch jobs are quite similar to running serial jobs, we just need to specify a MATLAB Pool to use and of course MATLAB code that is parallelized. This is easiest illustrated with an example:</p>
<ul class="simple">
<li><p>To make a pool of workers, and to give input etc.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">job</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="nd">@SCRIPT</span><span class="p">,</span> <span class="c1">#output, {input1, input2, input3, ...}, &#39;pool&#39;, #workers);</span>
</pre></div>
</div>
<p><strong>Example:</strong></p>
<p>Running a simple Matlab script, parallel-example.m, giving the input “16”, creating 4 workers, expecting 1 output. I use <code class="docutils literal notranslate"><span class="pre">j</span></code> instead of <code class="docutils literal notranslate"><span class="pre">job</span></code> to show that you can name as you want.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="nd">@parallel_example</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">16</span><span class="p">},</span> <span class="s1">&#39;pool&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</pre></div>
</div>
<p>Let us try running this on Kebnekaise, including checking state and then getting output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="nd">@parallel_example</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">16</span><span class="p">},</span> <span class="s1">&#39;pool&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

<span class="n">additionalSubmitArgs</span> <span class="o">=</span>

   <span class="s1">&#39;--ntasks=5 --cpus-per-task=1 -A hpc2n2024-114 -t 01:00:00&#39;</span>

<span class="o">&gt;&gt;</span> <span class="n">j</span><span class="o">.</span><span class="n">State</span>

<span class="n">ans</span> <span class="o">=</span>

    <span class="s1">&#39;running&#39;</span>

<span class="o">&gt;&gt;</span> <span class="n">j</span><span class="o">.</span><span class="n">State</span>

<span class="n">ans</span> <span class="o">=</span>

    <span class="s1">&#39;finished&#39;</span>

<span class="o">&gt;&gt;</span> <span class="n">j</span><span class="o">.</span><span class="n">fetchOutputs</span><span class="p">{:}</span>

<span class="n">ans</span> <span class="o">=</span>

    <span class="mf">9.3387</span>

<span class="o">&gt;&gt;</span>
</pre></div>
</div>
<div class="admonition-try-the-above-example exercise important admonition" id="exercise-2">
<p class="admonition-title">Try the above example.</p>
<p>It should work on all the clusters.</p>
<p>This exercise assumes you did the previous ones on this page; loading MATLAB, doing the configCluster.sh, adding the job settings.</p>
<p>You can download <a class="reference external" href="https://raw.githubusercontent.com/UPPMAX/R-python-julia-matlab-HPC/refs/heads/main/exercises/matlab/parallel_example.m">parallel_example.m</a> here.</p>
</div>
<p>There is more information about batch jobs here on <a class="reference external" href="https://se.mathworks.com/help/parallel-computing/batch.html">Mathworks</a> .</p>
</section>
</section>
</section>
<section id="matlab-batch-jobs">
<h2>MATLAB batch jobs<a class="headerlink" href="#matlab-batch-jobs" title="Link to this heading"></a></h2>
<div class="admonition-content admonition">
<p class="admonition-title">Content</p>
<ul class="simple">
<li><dl class="simple">
<dt>Creating a batch script to run Matlab</dt><dd><ul>
<li><p>Serial</p></li>
<li><p>Parallel</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<p>While we can submit batch jobs (or even batch jobs of batch jobs) from inside MATLAB (and that may be the most common way of using the batch system with MATLAB), it is also possible to create a batch submit script and use that to run MATLAB.</p>
<p>The difference here is that when the batch script has been submitted, you cannot make changes to your job. It is not interactive. That is also an advantage - you can submit the job, log out, and then come back later and see the results.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">parpool</span></code> can only be used on UPPMAX and Cosmos.</p></li>
</ul>
</div>
<section id="serial-batch-jobs">
<h3>Serial batch jobs<a class="headerlink" href="#serial-batch-jobs" title="Link to this heading"></a></h3>
<p>Here is an example of a serial batch job for UPPMAX/HPC2N/LUNARC.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">UPPMAX</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">HPC2N</button><button aria-controls="panel-1-1-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-2" name="1-2" role="tab" tabindex="-1">LUNARC</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Change to your actual project number later</span>
<span class="c1">#SBATCH -A naiss2024-22-1202</span>
<span class="c1"># Asking for 1 core</span>
<span class="c1">#SBATCH -n 1</span>
<span class="c1"># Asking for 30 min (change as you want)</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH --error=matlab_%J.err</span>
<span class="c1">#SBATCH --output=matlab_%J.out</span>

<span class="c1"># Clean the environment</span>
<span class="n">module</span> <span class="n">purge</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="c1"># Change depending on resource and MATLAB version</span>
<span class="c1"># to find out available versions: module spider matlab</span>
<span class="n">module</span> <span class="n">add</span> <span class="n">matlab</span><span class="o">/</span><span class="n">R2023b</span>

<span class="c1"># Executing the matlab program monte_carlo_pi.m for the value n=100000</span>
<span class="c1"># (n is number of steps - see program).</span>
<span class="c1"># The command &#39;time&#39; is timing the execution</span>
<span class="n">time</span> <span class="n">matlab</span> <span class="o">-</span><span class="n">nojvm</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;monte_carlo_pi(100000)&quot;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Change to your actual project number later</span>
<span class="c1">#SBATCH -A hpc2n2024-114</span>
<span class="c1"># Asking for 1 core</span>
<span class="c1">#SBATCH -n 1</span>
<span class="c1"># Asking for 30 min (change as you want)</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH --error=matlab_%J.err</span>
<span class="c1">#SBATCH --output=matlab_%J.out</span>

<span class="c1"># Clean the environment</span>
<span class="n">module</span> <span class="n">purge</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="c1"># Change depending on resource and MATLAB version</span>
<span class="c1"># to find out available versions: module spider matlab</span>
<span class="n">module</span> <span class="n">add</span> <span class="n">MATLAB</span><span class="o">/</span><span class="mi">2023</span><span class="n">a</span><span class="o">.</span><span class="n">Update4</span>

<span class="c1"># Executing the matlab program monte_carlo_pi.m for the value n=100000</span>
<span class="c1"># (n is number of steps - see program).</span>
<span class="c1"># The command &#39;time&#39; is timing the execution</span>
<span class="n">time</span> <span class="n">matlab</span> <span class="o">-</span><span class="n">nojvm</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;monte_carlo_pi(100000)&quot;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-2" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-2" name="1-2" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Change to your actual project number later</span>
<span class="c1">#SBATCH -A lu2024-7-80</span>
<span class="c1"># Asking for 1 core</span>
<span class="c1">#SBATCH -n 1</span>
<span class="c1"># Asking for 30 min (change as you want)</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH --error=matlab_%J.err</span>
<span class="c1">#SBATCH --output=matlab_%J.out</span>

<span class="c1"># Clean the environment</span>
<span class="n">module</span> <span class="n">purge</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="c1"># Change depending on resource and MATLAB version</span>
<span class="c1"># to find out available versions: module spider matlab</span>
<span class="n">module</span> <span class="n">add</span> <span class="n">matlab</span><span class="o">/</span><span class="mi">2023</span><span class="n">b</span>

<span class="c1"># Executing the matlab program monte_carlo_pi.m for the value n=100000</span>
<span class="c1"># (n is number of steps - see program).</span>
<span class="c1"># The command &#39;time&#39; is timing the execution</span>
<span class="n">time</span> <span class="n">matlab</span> <span class="o">-</span><span class="n">nojvm</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;monte_carlo_pi(100000)&quot;</span>
</pre></div>
</div>
</div></div>
<p>You can download <a class="reference external" href="https://raw.githubusercontent.com/UPPMAX/R-python-julia-matlab-HPC/refs/heads/main/exercises/matlab/monte_carlo_pi.m">monte_carlo_pi.m</a> here or find it under matlab in the exercises directory.</p>
<p>You the submit it with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sbatch</span> <span class="o">&lt;</span><span class="n">batchscript</span><span class="o">.</span><span class="n">sh</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">&lt;batchscript.sh&gt;</span></code> is the name you gave your batchscript. You can find ones for each of the clusters in the <code class="docutils literal notranslate"><span class="pre">exercises</span> <span class="pre">-&gt;</span> <span class="pre">matlab</span></code> directory, named <code class="docutils literal notranslate"><span class="pre">monte_carlo_pi_&lt;cluster&gt;.sh</span></code>.</p>
<div class="admonition-exercise exercise important admonition" id="exercise-3">
<p class="admonition-title">Exercise</p>
<p>Try run the serial batch script. Submit it, then check that it is running with <code class="docutils literal notranslate"><span class="pre">squeue</span> <span class="pre">--me</span></code>. Check the output in the <code class="docutils literal notranslate"><span class="pre">matlab_JOBID.out</span></code> (and the error in the <code class="docutils literal notranslate"><span class="pre">matlab_JOBID.err</span></code> file).</p>
</div>
</section>
<section id="parallel-batch-script">
<h3>Parallel batch script<a class="headerlink" href="#parallel-batch-script" title="Link to this heading"></a></h3>
<p>This is an example batch script for parallel MATLAB</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Change to your actual project number</span>
<span class="c1">#SBATCH -A XXXX-YY-ZZZ</span>
<span class="c1">#SBATCH --ntasks-per-node=&lt;how many tasks&gt;</span>
<span class="c1">#SBATCH --nodes &lt;how many nodes&gt;</span>

<span class="c1"># Asking for 30 min (change as you want)</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH --error=matlab_%J.err</span>
<span class="c1">#SBATCH --output=matlab_%J.out</span>

<span class="c1"># Clean the environment</span>
<span class="n">module</span> <span class="n">purge</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="c1"># Change depending on resource and MATLAB version</span>
<span class="c1"># to find out available versions: module spider matlab</span>
<span class="n">module</span> <span class="n">add</span> <span class="n">MATLAB</span><span class="o">/&lt;</span><span class="n">version</span><span class="o">&gt;</span>

<span class="c1"># Executing a parallel matlab program</span>
<span class="n">srun</span> <span class="n">matlab</span> <span class="o">-</span><span class="n">nojvm</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">nodesktop</span> <span class="o">-</span><span class="n">nosplash</span> <span class="o">-</span><span class="n">r</span> <span class="n">parallel</span><span class="o">-</span><span class="n">matlab</span><span class="o">-</span><span class="n">script</span><span class="o">.</span><span class="n">m</span>
</pre></div>
</div>
<p>Inside the MATLAB code, the number of CPU-cores (NumWorkers in MATLAB terminology) can be specified when creating the parallel pool, for example, with 8 threads:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">poolobj</span> <span class="o">=</span> <span class="n">parpool</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition-exercise exercise important admonition" id="exercise-4">
<p class="admonition-title">Exercise</p>
<p>Try making a batch script for running the <code class="docutils literal notranslate"><span class="pre">parallel_example.m</span></code> that was run in the example from inside MATLAB above. You can use the above batch script as template.</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Solution</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">UPPMAX</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">HPC2N</button><button aria-controls="panel-2-2-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-2" name="2-2" role="tab" tabindex="-1">LUNARC</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><dl class="field-list simple">
<dt class="field-odd">class<span class="colon">:</span></dt>
<dd class="field-odd"><p>dropdown</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Change to your actual project number</span>
<span class="c1">#SBATCH -A naiss2024-22-1202</span>
<span class="c1"># Remember, there are 4 workers and 1 master!</span>
<span class="c1">#SBATCH --ntasks=5</span>
<span class="c1">#SBATCH --cpus-per-task=1</span>
<span class="c1">#SBATCH --ntasks-per-node=5</span>
<span class="c1">#SBATCH --ntasks-per-core=1</span>
<span class="c1"># Asking for 30 min (change as you want)</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH --error=matlab_%J.err</span>
<span class="c1">#SBATCH --output=matlab_%J.out</span>

<span class="c1"># Clean the environment</span>
<span class="n">module</span> <span class="n">purge</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="c1"># Change depending on resource and MATLAB version</span>
<span class="c1"># to find out available versions: module spider matlab</span>
<span class="n">module</span> <span class="n">add</span> <span class="n">matlab</span><span class="o">/</span><span class="n">R2023b</span>

<span class="c1"># Executing a parallel matlab program</span>
<span class="n">srun</span> <span class="n">matlab</span> <span class="o">-</span><span class="n">nojvm</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">nodesktop</span> <span class="o">-</span><span class="n">nosplash</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;parallel_example(16)&quot;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><dl class="field-list simple">
<dt class="field-odd">class<span class="colon">:</span></dt>
<dd class="field-odd"><p>dropdown</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Change to your actual project number</span>
<span class="c1">#SBATCH -A hpc2n2024-114</span>
<span class="c1"># Remember, there are 4 workers and 1 master!</span>
<span class="c1">#SBATCH --ntasks=5</span>
<span class="c1">#SBATCH --cpus-per-task=1</span>
<span class="c1">#SBATCH --ntasks-per-node=5</span>
<span class="c1">#SBATCH --ntasks-per-core=1</span>
<span class="c1"># Asking for 30 min (change as you want)</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH --error=matlab_%J.err</span>
<span class="c1">#SBATCH --output=matlab_%J.out</span>

<span class="c1"># Clean the environment</span>
<span class="n">module</span> <span class="n">purge</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="c1"># Change depending on resource and MATLAB version</span>
<span class="c1"># to find out available versions: module spider matlab</span>
<span class="n">module</span> <span class="n">add</span> <span class="n">MATLAB</span><span class="o">/</span><span class="mi">2023</span><span class="n">a</span><span class="o">.</span><span class="n">Update4</span>

<span class="c1"># Executing a parallel matlab program</span>
<span class="n">srun</span> <span class="n">matlab</span> <span class="o">-</span><span class="n">nojvm</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">nodesktop</span> <span class="o">-</span><span class="n">nosplash</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;parallel_example(16)&quot;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-2" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-2" name="2-2" role="tabpanel" tabindex="0"><dl class="field-list simple">
<dt class="field-odd">class<span class="colon">:</span></dt>
<dd class="field-odd"><p>dropdown</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Change to your actual project number</span>
<span class="c1">#SBATCH -A lu2024-7-80</span>
<span class="c1"># Remember, there are 4 workers and 1 master!</span>
<span class="c1">#SBATCH --ntasks=5</span>
<span class="c1">#SBATCH --cpus-per-task=1</span>
<span class="c1">#SBATCH --ntasks-per-node=5</span>
<span class="c1">#SBATCH --ntasks-per-core=1</span>
<span class="c1"># Asking for 30 min (change as you want)</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH --error=matlab_%J.err</span>
<span class="c1">#SBATCH --output=matlab_%J.out</span>

<span class="c1"># Clean the environment</span>
<span class="n">module</span> <span class="n">purge</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="c1"># Change depending on resource and MATLAB version</span>
<span class="c1"># to find out available versions: module spider matlab</span>
<span class="n">module</span> <span class="n">add</span> <span class="n">matlab</span><span class="o">/</span><span class="mi">2023</span><span class="n">b</span>

<span class="c1"># Executing a parallel matlab program</span>
<span class="n">srun</span> <span class="n">matlab</span> <span class="o">-</span><span class="n">nojvm</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">nodesktop</span> <span class="o">-</span><span class="n">nosplash</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;parallel_example(16)&quot;</span>
</pre></div>
</div>
</div></div>
</div>
</section>
</section>
<section id="gpu-code">
<h2>GPU code<a class="headerlink" href="#gpu-code" title="Link to this heading"></a></h2>
<div class="admonition-content admonition">
<p class="admonition-title">Content</p>
<ul class="simple">
<li><dl class="simple">
<dt>How to use GPUs with Matlab</dt><dd><ul>
<li><p>Inside Matlab</p></li>
<li><p>In a batch script</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<p>In order to use GPUs, you have to ask for them.</p>
<section id="inside-matlab">
<h3>Inside MATLAB<a class="headerlink" href="#inside-matlab" title="Link to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In order to use GPUs from inside MATLAB, you add them as additional properties to your profile.</p>
<p>Remember, after it is saved to your profile it will use GPUs again next time you submit a job, even if you don’t want GPUs there. To reset this, do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">AdditionalProperties</span><span class="o">.</span><span class="n">GpuCard</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">c</span><span class="o">.</span><span class="n">AdditionalProperties</span><span class="o">.</span><span class="n">GpusPerNode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="admonition-gpu-in-batch-job admonition">
<p class="admonition-title">GPU in batch job</p>
<p>This is how you add GPUs to use in batch jobs submitted inside MATLAB:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">UPPMAX</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">HPC2N</button><button aria-controls="panel-3-3-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-2" name="3-2" role="tab" tabindex="-1">LUNARC</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><p>Note: you have to first do an interactive session to Snowy, asking for GPUs, since there are no GPUs on Rackham. You should ask for at least 2 cores so Matlab will start. Ask for a GPU and enough time to do what you need.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>interactive<span class="w"> </span>-A<span class="w"> </span>naiss2024-22-1202<span class="w"> </span>-n<span class="w"> </span><span class="m">2</span><span class="w"> </span>-M<span class="w"> </span>snowy<span class="w"> </span>--gres<span class="o">=</span>gpu:1<span class="w">  </span>-t<span class="w"> </span><span class="m">2</span>:00:00
</pre></div>
</div>
<p>Load Matlab</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ml</span> <span class="n">matlab</span><span class="o">/</span><span class="n">R2023b</span>
</pre></div>
</div>
<p>Run Matlab either as GUI</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matlab</span> <span class="o">-</span><span class="n">singleCompThread</span>
</pre></div>
</div>
<p>Or on the terminal</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matlab</span> <span class="o">-</span><span class="n">singleCompThread</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">nosplash</span> <span class="o">-</span><span class="n">nodesktop</span>
</pre></div>
</div>
<p>Then, inside MATLAB, you need to add this to your profile</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">.</span><span class="n">AdditionalProperties</span><span class="p">.</span><span class="n">GpusPerNode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">c</span><span class="p">.</span><span class="n">saveProfile</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>Load and start Matlab, then do</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">.</span><span class="n">AdditionalProperties</span><span class="p">.</span><span class="n">GpuCard</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;card-type&#39;</span><span class="p">;</span>
<span class="n">c</span><span class="p">.</span><span class="n">AdditionalProperties</span><span class="p">.</span><span class="n">GpusPerNode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;#gpus&#39;</span><span class="p">;</span>
<span class="n">c</span><span class="p">.</span><span class="n">saveProfile</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">card-type</span></code> is one of: v100, a40, a6000, l40s, a100, h100, mi100</p>
<p>and <code class="docutils literal notranslate"><span class="pre">#gpus</span></code> depends on the card-type:</p>
<ul class="simple">
<li><p>V100 (2 cards/node)</p></li>
<li><p>A40 (8 cards/node)</p></li>
<li><p>A6000 (2 cards/node)</p></li>
<li><p>L40s (2 or 6 cards/node)</p></li>
<li><p>A100 (2 cards/node)</p></li>
<li><p>H100 (4 cards/node)</p></li>
<li><p>MI100 (2 cards/node)</p></li>
</ul>
</div><div aria-labelledby="tab-3-3-2" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-2" name="3-2" role="tabpanel" tabindex="0"><p>Load and start Matlab, then do</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">.</span><span class="n">AdditionalProperties</span><span class="p">.</span><span class="n">GpusPerNode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>#<span class="n">GPUs</span><span class="p">;</span>
<span class="n">c</span><span class="p">.</span><span class="n">saveProfile</span>
</pre></div>
</div>
<p>where #GPUs is 1 or 2.</p>
</div></div>
</div>
<div class="admonition-exercise exercise important admonition" id="exercise-5">
<p class="admonition-title">Exercise</p>
<p>Try and add GPUs to your cluster profile, save it. Run <code class="docutils literal notranslate"><span class="pre">c.AdditionalProperties</span></code> to see what was added. Then do <code class="docutils literal notranslate"><span class="pre">c.AdditionalProperties.GpusPerNode</span> <span class="pre">=</span> <span class="pre">'';</span></code> to remove it. See that it was removed.</p>
</div>
</section>
<section id="batch-scripts">
<h3>Batch scripts<a class="headerlink" href="#batch-scripts" title="Link to this heading"></a></h3>
<p>In order to use GPUs in a batch job, you do something like this:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">UPPMAX</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">HPC2N</button><button aria-controls="panel-4-4-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-2" name="4-2" role="tab" tabindex="-1">LUNARC</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Change to your actual project number</span>
<span class="c1">#SBATCH -A naiss20224-22-1202</span>
<span class="c1">#SBATCH -n 2</span>
<span class="c1">#SBATCH -M snowy</span>
<span class="c1">#SBATCH --gres=gpu:1</span>
<span class="c1"># Asking for 30 min (change as you want)</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH --error=matlab_%J.err</span>
<span class="c1">#SBATCH --output=matlab_%J.out</span>

<span class="c1"># Clean the environment</span>
<span class="n">module</span> <span class="n">purge</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="c1"># Change depending on resource and MATLAB version</span>
<span class="c1"># to find out available versions: module spider matlab</span>
<span class="n">module</span> <span class="n">add</span> <span class="n">matlab</span><span class="o">/</span><span class="n">R2023b</span>

<span class="c1"># Executing a parallel matlab program</span>
<span class="n">matlab</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">nosplash</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;gpu-matlab-script.m&quot;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Change to your actual project number</span>
<span class="c1">#SBATCH -A hpc2n2024-114</span>
<span class="c1">#SBATCH -n 1</span>
<span class="c1">#SBATCH --gpus=&lt;#gpus&gt;</span>
<span class="c1">#SBATCH -C &lt;gpu-type&gt;</span>
<span class="c1"># Asking for 30 min (change as you want)</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH --error=matlab_%J.err</span>
<span class="c1">#SBATCH --output=matlab_%J.out</span>

<span class="c1"># Clean the environment</span>
<span class="n">module</span> <span class="n">purge</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="c1"># Change depending on resource and MATLAB version</span>
<span class="c1"># to find out available versions: module spider matlab</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">MATLAB</span><span class="o">/</span><span class="mi">2023</span><span class="n">a</span><span class="o">.</span><span class="n">Update4</span>

<span class="c1"># Executing a parallel matlab program</span>
<span class="n">matlab</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">nosplash</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;gpu-matlab-script.m&quot;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">gpu-type</span></code> is one of: v100, a40, a6000, l40s, a100, h100, mi100</p>
<p>and <code class="docutils literal notranslate"><span class="pre">#gpus</span></code> depends on the card-type:</p>
<ul class="simple">
<li><p>V100 (2 cards/node)</p></li>
<li><p>A40 (8 cards/node)</p></li>
<li><p>A6000 (2 cards/node)</p></li>
<li><p>L40s (2 or 6 cards/node)</p></li>
<li><p>A100 (2 cards/node)</p></li>
<li><p>H100 (4 cards/node)</p></li>
<li><p>MI100 (2 cards/node)</p></li>
</ul>
</div><div aria-labelledby="tab-4-4-2" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-2" name="4-2" role="tabpanel" tabindex="0"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Change to your actual project number</span>
<span class="c1">#SBATCH -A lu2024-7-80</span>
<span class="c1">#SBATCH -n 1</span>
<span class="c1">#SBATCH -p gpua100</span>
<span class="c1"># The number of GPUs.#gpus, can be 1 or 2</span>
<span class="c1">#SBATCH --gpus=&lt;#gpus&gt;</span>

<span class="c1"># Asking for 30 min (change as you want)</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH --error=matlab_%J.err</span>
<span class="c1">#SBATCH --output=matlab_%J.out</span>

<span class="c1"># Clean the environment</span>
<span class="n">module</span> <span class="n">purge</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="c1"># Change depending on resource and MATLAB version</span>
<span class="c1"># to find out available versions: module spider matlab</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">matlab</span><span class="o">/</span><span class="mi">2023</span><span class="n">b</span>

<span class="c1"># Executing a parallel matlab program</span>
<span class="n">matlab</span> <span class="o">-</span><span class="n">nodisplay</span> <span class="o">-</span><span class="n">nosplash</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;gpu-matlab-script.m&quot;</span>
</pre></div>
</div>
</div></div>
<div class="admonition-keypoints keypoints admonition" id="keypoints-0">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>The SLURM scheduler handles allocations to the calculation/compute nodes</p></li>
<li><p>Batch jobs run without interaction with user</p></li>
<li><p>A batch script consists of a part with SLURM parameters describing the allocation and a second part describing the actual work within the job, for instance one or several Matlab scripts.</p></li>
<li><p>You can run MATLAB as a batch job through a batch script or from inside MATLAB (shell or GUI)</p></li>
<li><p>Remember to include possible input arguments to the MATLAB script in the batch script.</p></li>
<li><p><strong>You need to configure MATLAB before submitting batch jobs.</strong></p></li>
</ul>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="load_runMatlab.html" class="btn btn-neutral float-left" title="Load and Run MATLAB" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="jobsMatlab.html" class="btn btn-neutral float-right" title="MATLAB GUI and SLURM" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, UPPMAX &amp; HPC2N.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>